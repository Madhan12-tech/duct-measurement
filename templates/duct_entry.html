<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Duct Entry</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .top-info {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      background: #f9f9f9;
    }

    .top-info div {
      flex: 1 0 20%;
      margin-bottom: 5px;
    }

    .container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 10px;
    }

    .form-container {
      flex: 1 1 5%;
      min-width: 300px;
    }

    .table-container {
      flex: 1 1 58%;
      min-width: 400px;
      position: relative;
    }

    form input, form select, form button {
      display: block;
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .export-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 5px;
    }

    .export-buttons button {
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .export-buttons button:hover {
      background: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: auto;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .hidden {
      display: none;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      display: none;
      z-index: 9999;
    }

    .edited-row {
      animation: highlight 2s ease;
    }

    @keyframes highlight {
      from { background-color: #ffffcc; }
      to { background-color: white; }
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .export-buttons {
        justify-content: center;
      }
    }

    #submitSuccessTime {
      font-size: 13px;
      color: green;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<h2>Project & Client Info</h2>
<div class="top-info">
  <div><strong>Project Name:</strong> {{ project[1] }}</div>
  <div><strong>Enquiry No:</strong> {{ project[2] }}</div>
  <div><strong>Company:</strong> {{ project[3] }}</div>
  <div><strong>GST No:</strong> {{ project[4] }}</div>
  <div><strong>Office Contact:</strong> {{ project[5] }}</div>
  <div><strong>Site Contact:</strong> {{ project[6] }}</div>
  <div><strong>Site Engineer:</strong> {{ project[7] }}</div>
  <div><strong>Location:</strong> {{ project[8] }}</div>
  <div><strong>Floors:</strong> {{ project[9] }}</div>
  <div><strong>Units:</strong> {{ project[10] }}</div>
</div>

<div class="container">
  <div class="form-container">
    <h3>Add Duct</h3>
    <form id="ductForm">
      <input type="hidden" name="project_id" value="{{ project[0] }}">
      <input type="hidden" name="duct_id" id="duct_id">
      <input type="text" name="duct_no" placeholder="Duct No" required>
      <select name="duct_type" id="duct_type" required onchange="toggleFactor()">
        <option value="">Select Type</option>
        <option value="elb">Elbow</option>
        <option value="vanes">Vanes</option>
        <option value="shoe">Shoe</option>
        <option value="offset">Offset</option>
        <option value="dm">Duct Main</option>
        <option value="red">Reducer</option>
        <option value="st">Straight</option>
      </select>
      <input type="number" name="w1" placeholder="W1">
      <input type="number" name="h1" placeholder="H1">
      <input type="number" name="w2" placeholder="W2">
      <input type="number" name="h2" placeholder="H2">
      <input type="number" name="length_or_radius" placeholder="Length / Radius">
      <input type="number" name="quantity" placeholder="Quantity" required>
      <input type="number" name="offset_deg" placeholder="Degree / Offset">
      <input type="number" name="factor" placeholder="Factor" id="factor_field" class="hidden">
      <button type="submit">Add / Update</button>
    </form>
  </div>

  <div class="table-container">
    <div class="export-buttons">
      <button onclick="exportFile('excel')">üìä Excel</button>
      <button onclick="exportFile('pdf')">üìÑ PDF</button>
      <button onclick="window.print()">üñ®Ô∏è Print</button>
    </div>

    <h3>Duct Entries</h3>
    <table>
      <thead>
        <tr>
          <th>Duct No</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
          <th>Len/Radius</th><th>Qty</th><th>Deg/Offset</th><th>Gauge</th><th>Area</th>
          <th>24g</th><th>22g</th><th>20g</th><th>18g</th>
          <th>Nuts</th><th>Cleat</th><th>Gasket</th><th>Corner</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for duct in ducts %}
        <tr id="row-{{ duct[0] }}">
          <td>{{ duct[2] }}</td><td>{{ duct[3] }}</td>
          <td>{{ duct[4]|int }}</td><td>{{ duct[5]|int }}</td>
          <td>{{ duct[6]|int }}</td><td>{{ duct[7]|int }}</td>
          <td>{{ duct[8]|int }}</td><td>{{ duct[10] }}</td>
          <td>{{ duct[11]|int }}</td><td>{{ duct[12] }}</td>
          <td>{{ "%.2f"|format(duct[13]) }}</td>
          <td>{{ "%.2f"|format(duct[14]) }}</td>
          <td>{{ "%.2f"|format(duct[15]) }}</td>
          <td>{{ "%.2f"|format(duct[16]) }}</td>
          <td>{{ "%.2f"|format(duct[17]) }}</td>
          <td>{{ duct[18] }}</td><td>{{ duct[19] }}</td>
          <td>{{ "%.2f"|format(duct[20]) }}</td><td>{{ duct[21] }}</td>
          <td>
            <button onclick="editDuct({{ duct[0] }})">‚úèÔ∏è</button>
            <a href="/duct/{{ duct[0] }}/delete" onclick="return confirm('Delete this entry?')">üóëÔ∏è</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- ‚úÖ Submit Button Moved Here -->
    <div class="action-buttons" style="margin-top: 15px; text-align: right;">
      <button id="submitBtn" onclick="submitProject()">üì© Submit</button>
      <div id="submitSuccessTime"></div>
    </div>
  </div>
</div>

<div class="toast" id="toastMsg"></div>

<script>
  function showToast(message) {
    const toast = document.getElementById("toastMsg");
    toast.innerText = message;
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 3000);
  }

  function exportFile(type) {
    const projectId = "{{ project[0] }}";
    const url = type === 'excel' ? `/export_excel/${projectId}` : `/export_pdf/${projectId}`;
    fetch(url)
      .then(response => response.blob())
      .then(blob => {
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob);
        a.download = type === 'excel' ? 'duct.xlsx' : 'duct.pdf';
        a.click();
        showToast(`‚úÖ ${type.toUpperCase()} Exported Successfully`);
      });
  }

  function toggleFactor() {
    const type = document.getElementById('duct_type').value;
    const factorField = document.getElementById('factor_field');
    factorField.classList.toggle('hidden', !['red', 'offset', 'shoe', 'elb'].includes(type));
  }

  document.getElementById("ductForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = {};
    formData.forEach((v, k) => data[k] = v);
    fetch("/duct", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
      showToast(res.message);
      window.location.reload();
    });
  });

  function editDuct(id) {
    fetch(`/duct/${id}/edit`)
      .then(res => res.json())
      .then(data => {
        Object.keys(data).forEach(key => {
          const input = document.querySelector(`[name="${key}"]`);
          if (input) input.value = data[key];
        });
        document.getElementById("duct_id").value = data.id;
        toggleFactor();
        const row = document.getElementById(`row-${id}`);
        if (row) {
          row.classList.add("edited-row");
          setTimeout(() => row.classList.remove("edited-row"), 2000);
        }
      });
  }

  function submitProject() {
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    fetch(`/submit/{{ project[0] }}`, {
      method: "POST"
    }).then(response => {
      showToast("‚úÖ Submitted Successfully");
      const timestamp = new Date().toLocaleString();
      document.getElementById("submitSuccessTime").innerText = `‚úîÔ∏è Submitted at ${timestamp}`;
    }).catch(() => {
      showToast("‚ùå Submission Failed");
      submitBtn.disabled = false;
    });
  }
</script>

</body>
</html>
