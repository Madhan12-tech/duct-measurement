<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Duct Entry</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body.dark-mode { background-color: #121212; color: white; }
    .form-section { max-width: 500px; }
    .dark-mode .table, .dark-mode input, .dark-mode select {
      background-color: #333; color: white; border-color: #555;
    }
    .gauge-24g { background-color: #d4edda; }  /* Green */
    .gauge-22g { background-color: #dbeafe; }  /* Blue */
    .gauge-20g { background-color: #fff3cd; }  /* Orange */
    .gauge-18g { background-color: #f8d7da; }  /* Red */
  </style>
</head>
<body>
  <div class="container-fluid p-3">
    <div class="d-flex justify-content-between mb-3">
      <h5>Project: {{ project[1] }} | Enquiry: {{ project[2] }} | Engineer: {{ project[4] }}</h5>
      <button class="btn btn-sm btn-dark" onclick="toggleDarkMode()">Dark Mode</button>
    </div>

    <div class="row">
      <!-- Form -->
      <div class="col-md-4 form-section">
        <form method="POST" action="{{ url_for('add_duct') }}">
          <input type="hidden" name="project_id" value="{{ project_id }}">
          {% if edit_entry %}<input type="hidden" name="id" value="{{ edit_entry[0] }}">{% endif %}

          <div class="mb-2"><label>Duct No</label><input type="text" class="form-control" name="duct_no" required value="{{ edit_entry[2] if edit_entry else '' }}"></div>
          <div class="mb-2">
            <label>Duct Type</label>
            <select name="duct_type" class="form-control" id="duct_type" onchange="toggleFactorField()" required>
              {% for type in ['ST','RED','DUM','OFFSET','SHOE','VANES','ELB'] %}
                <option value="{{ type }}" {% if edit_entry and edit_entry[3] == type %}selected{% endif %}>{{ type }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2"><label>Width1</label><input type="number" name="width1" step="0.01" class="form-control" required value="{{ edit_entry[4] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Height1</label><input type="number" name="height1" step="0.01" class="form-control" required value="{{ edit_entry[5] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Width2</label><input type="number" name="width2" step="0.01" class="form-control" value="{{ edit_entry[6] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Height2</label><input type="number" name="height2" step="0.01" class="form-control" value="{{ edit_entry[7] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Length/Radius</label><input type="number" name="length_or_radius" step="0.01" class="form-control" required value="{{ edit_entry[8] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Quantity</label><input type="number" name="quantity" class="form-control" required value="{{ edit_entry[9] if edit_entry else '' }}"></div>
          <div class="mb-2"><label>Degree/Offset</label><input type="number" name="degree_or_offset" step="0.01" class="form-control" value="{{ edit_entry[10] if edit_entry else '' }}"></div>

          <div class="mb-2" id="factorField" style="display:none;">
            <label>Factor</label>
            <input type="number" step="0.1" name="factor" class="form-control" value="{{ edit_entry[11] if edit_entry else 1.5 }}">
          </div>

          <button type="submit" class="btn btn-primary">{{ 'Update' if edit_entry else 'Add' }}</button>
        </form>
        {% with messages = get_flashed_messages() %}
          {% if messages %}<div class="alert alert-info mt-2">{{ messages[0] }}</div>{% endif %}
        {% endwith %}
      </div>

      <!-- Table -->
      <div class="col-md-8">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Duct No</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
              <th>Len/Rad</th><th>Qty</th><th>Deg/Off</th><th>Factor</th><th>Gauge</th><th>Area</th>
              <th>Nuts</th><th>Cleat</th><th>Gasket</th><th>Corner</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in entries %}
              <tr class="gauge-{{ entry[12] }}">
                <td>{{ loop.index }}</td><td>{{ entry[2] }}</td><td>{{ entry[3] }}</td><td>{{ entry[4] }}</td>
                <td>{{ entry[5] }}</td><td>{{ entry[6] }}</td><td>{{ entry[7] }}</td><td>{{ entry[8] }}</td>
                <td>{{ entry[9] }}</td><td>{{ entry[10] }}</td><td>{{ entry[11] }}</td><td>{{ entry[12] }}</td>
                <td>{{ '%.2f'|format(entry[13]) }}</td><td>{{ entry[14] }}</td><td>{{ entry[15] }}</td>
                <td>{{ '%.2f'|format(entry[16]) }}</td><td>{{ entry[17] }}</td>
                <td>
                  <a href="{{ url_for('edit_duct', id=entry[0]) }}" class="btn btn-sm btn-warning">Edit</a>
                  <a href="{{ url_for('delete_duct', id=entry[0]) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this entry?')">Delete</a>
                </td>
              </tr>
            {% endfor %}

            <!-- Summary Row -->
            <tr class="table-info fw-bold">
              <td colspan="8">Total</td>
              <td>{{ total_qty }}</td><td>-</td><td>-</td><td>-</td>
              <td>{{ '%.2f'|format(total_area) }}</td>
              <td>{{ total_bolts }}</td><td>{{ total_cleat }}</td>
              <td>{{ '%.2f'|format(total_gasket) }}</td><td>{{ total_corner }}</td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <div class="mt-2">
          <a href="{{ url_for('export_excel', project_id=project_id) }}" class="btn btn-success btn-sm">Export to Excel</a>
          <a href="{{ url_for('export_pdf', project_id=project_id) }}" class="btn btn-danger btn-sm">Export to PDF</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleDarkMode() { document.body.classList.toggle("dark-mode"); }
    function toggleFactorField() {
      const show = ["RED", "OFFSET", "SHOE", "ELB"].includes(document.getElementById("duct_type").value);
      document.getElementById("factorField").style.display = show ? "block" : "none";
    }
    window.onload = toggleFactorField;
  </script>
</body>
</html>
