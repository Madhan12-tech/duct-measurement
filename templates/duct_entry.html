<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Duct Entry</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body.dark-mode {
      background-color: #121212;
      color: white;
    }
    .dark-mode input, .dark-mode select {
      background-color: #1e1e1e;
      color: white;
      border: 1px solid #555;
    }
    .form-section {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .dark-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 999;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <button class="btn btn-sm btn-secondary dark-toggle" onclick="toggleDarkMode()">ðŸŒ™</button>

  <h4>Project: {{ project[1] }} | Engineer: {{ project[4] }}</h4>
  <p><strong>Enquiry:</strong> {{ project[2] }} | <strong>Office No:</strong> {{ project[3] }} | <strong>Contact:</strong> {{ project[5] }} | <strong>Location:</strong> {{ project[6] }}</p>

  <form action="{{ url_for('add_duct') }}" method="POST" class="form-section">
    <input type="hidden" name="project_id" value="{{ project_id }}">
    {% if edit_entry %}
      <input type="hidden" name="id" value="{{ edit_entry[0] }}">
    {% endif %}
    <div class="row">
      <div class="col-md-2">
        <label>Duct No</label>
        <input type="text" name="duct_no" class="form-control" required value="{{ edit_entry[2] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Type</label>
        <select name="duct_type" class="form-control" onchange="toggleFactor(this.value)" required>
          {% set types = ['ST', 'RED', 'DUM', 'OFFSET', 'SHOE', 'VANES', 'ELB'] %}
          {% for t in types %}
            <option value="{{ t }}" {% if edit_entry and edit_entry[3]==t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label>Width 1</label>
        <input type="number" step="any" name="width1" class="form-control" required value="{{ edit_entry[4] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Height 1</label>
        <input type="number" step="any" name="height1" class="form-control" required value="{{ edit_entry[5] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Width 2</label>
        <input type="number" step="any" name="width2" class="form-control" value="{{ edit_entry[6] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Height 2</label>
        <input type="number" step="any" name="height2" class="form-control" value="{{ edit_entry[7] if edit_entry else '' }}">
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-md-2">
        <label>Length/Radius</label>
        <input type="number" step="any" name="length_or_radius" class="form-control" required value="{{ edit_entry[8] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Qty</label>
        <input type="number" name="quantity" class="form-control" required value="{{ edit_entry[9] if edit_entry else '' }}">
      </div>
      <div class="col-md-2">
        <label>Degree/Offset</label>
        <input type="number" step="any" name="degree_or_offset" class="form-control" value="{{ edit_entry[10] if edit_entry else '' }}">
      </div>
      <div class="col-md-2" id="factorCol">
        <label>Factor</label>
        <select name="factor" class="form-control">
          {% for f in [1, 1.25, 1.5, 2] %}
            <option value="{{ f }}" {% if edit_entry and edit_entry[11]==f %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label style="visibility: hidden;">Submit</label><br>
        <button class="btn btn-success" type="submit">{{ 'Update' if edit_entry else 'Add' }}</button>
        {% if edit_entry %}
          <a href="{{ url_for('home', project_id=project_id) }}" class="btn btn-warning">Cancel Edit</a>
        {% endif %}
      </div>
    </div>
  </form>

  <h5 class="mt-4">Duct Entries</h5>
  <table class="table table-bordered table-sm table-striped">
    <thead class="thead-dark">
      <tr>
        <th>Duct No</th>
        <th>Type</th>
        <th>W1</th>
        <th>H1</th>
        <th>W2</th>
        <th>H2</th>
        <th>Length/Radius</th>
        <th>Qty</th>
        <th>Deg/Off</th>
        <th>Factor</th>
        <th>Gauge</th>
        <th>Area</th>
        <th>Bolts</th>
        <th>Cleat</th>
        <th>Gasket</th>
        <th>Corner</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
        <tr>
          <td>{{ e[2] }}</td>
          <td>{{ e[3] }}</td>
          <td>{{ e[4] }}</td>
          <td>{{ e[5] }}</td>
          <td>{{ e[6] }}</td>
          <td>{{ e[7] }}</td>
          <td>{{ e[8] }}</td>
          <td>{{ e[9] }}</td>
          <td>{{ e[10] }}</td>
          <td>{{ e[11] }}</td>
          <td>{{ e[12] }}</td>
          <td>{{ '%.2f'|format(e[13]) }}</td>
          <td>{{ e[14] }}</td>
          <td>{{ e[15] }}</td>
          <td>{{ '%.2f'|format(e[16]) }}</td>
          <td>{{ e[17] }}</td>
          <td>
            <a href="{{ url_for('edit_duct', id=e[0]) }}" class="btn btn-sm btn-info">Edit</a>
            <a href="{{ url_for('delete_duct', id=e[0]) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this entry?')">Delete</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <h6 class="mt-4">Summary</h6>
  <ul>
    <li>Total Quantity: {{ total_qty }}</li>
    <li>Total Area: {{ '%.2f'|format(total_area) }}</li>
    <li>Total Bolts: {{ total_bolts }}</li>
    <li>Total Cleats: {{ total_cleat }}</li>
    <li>Total Gasket (m): {{ '%.2f'|format(total_gasket) }}</li>
    <li>Total Corners: {{ total_corner }}</li>
  </ul>
  <ul>
    <li>Area 24g: {{ '%.2f'|format(area_24g) }}</li>
    <li>Area 22g: {{ '%.2f'|format(area_22g) }}</li>
    <li>Area 20g: {{ '%.2f'|format(area_20g) }}</li>
    <li>Area 18g: {{ '%.2f'|format(area_18g) }}</li>
  </ul>

  <a href="{{ url_for('export_excel', project_id=project_id) }}" class="btn btn-sm btn-success">Export Excel</a>
  <a href="{{ url_for('export_pdf', project_id=project_id) }}" class="btn btn-sm btn-danger">Export PDF</a>
</div>

<script>
  function toggleFactor(type) {
    const show = ['RED', 'OFFSET', 'SHOE', 'ELB'].includes(type);
    document.getElementById('factorCol').style.display = show ? 'block' : 'none';
  }

  window.onload = function () {
    const select = document.querySelector('select[name="duct_type"]');
    if (select) toggleFactor(select.value);
  };

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
  }
</script>
</body>
</html>
